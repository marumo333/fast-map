# Fast-Map

Fast-Mapは、Google Maps Platformを活用した高速なルート検索アプリケーションです。Next.js、TypeScript、Tailwind CSSを使用して構築されています。

## 主な機能

- 🗺️ Google Maps Platformを使用した高精度な地図表示
- 🚗 リアルタイムの交通情報に基づく最適なルート検索
- 📍 現在地の自動取得と位置情報の利用
- 🔄 ルート変更の自動検出と通知
- 🎯 目的地までの所要時間の正確な予測
- 🔔 交通状況の変化に応じたリアルタイム通知
- 🔒 ユーザー認証機能（ログイン・ログアウト）
  - メールアドレスとパスワードによる認証
  - セッション管理（Cookieベース）
  - 未認証ユーザーの自動リダイレクト
  - ナビゲーションバーからのログアウト機能
- ⚠️ **検索制限機能**
  - 1日3回までの目的地選択制限
  - 日付変更時に自動リセット
  - 残り検索回数の表示
  - 制限到達時の通知

## 開発ガイドライン

### コード品質の維持
- ESLintの警告やエラーは、可能な限り修正する
- 新機能追加時は、既存のコードスタイルに従う
- 型の安全性を確保する

### 既存機能の修正に関するルール
1. **既存機能の保護**
   - 既存の機能は原則として修正しない
   - 新機能追加時は、既存機能に影響を与えないよう注意

2. **修正が必要な場合**
   - 修正の必要性を明確に説明
   - 修正内容の影響範囲を特定
   - チームメンバーとの確認を必須とする

3. **修正プロセス**
   - 修正提案の作成
   - レビューの実施
   - 承認後の実装
   - テストの実施

4. **例外対応**
   - セキュリティ上の問題
   - 重大なバグの修正
   - パフォーマンスの著しい低下

## 認証機能

- ログイン必須のアプリケーション
- 未ログイン状態でのアクセスは自動的にログインページにリダイレクト
- ログイン状態はクッキーで管理
- ログアウト機能の実装
- セッション管理による自動ログアウト

## 使用制限

- 1人あたり1日3回までの目的地検索制限
  - Google Maps APIの使用量制限とコスト最適化のため
  - 日付が変わると自動的にリセット
  - 残り検索回数は毎回の検索時に表示

## 実装の苦労点

1. **認証システムの実装**
   - ミドルウェアによる認証チェック
   - クライアントサイドでのログイン状態管理
   - セキュアなクッキー管理
   - ログイン状態の永続化

2. **Google Maps APIの型定義とルート検索**
   - `@googlemaps/google-maps-services-js`の型定義が不完全で、特に`DirectionsStep`の型定義に苦労
   - 有料/無料道路の判定から最短/混雑回避ルートの判定に変更し、より実用的な機能に改善
   - ルート検索の最適化とパフォーマンス改善に注力

3. **ルート検索の最適化**
   - 複数のルート選択肢を表示する際のパフォーマンス最適化
   - 交通情報の取得と表示の実装
   - 不要なAPI呼び出しを防止するための制御機構の実装
   - エラー発生時の即時停止機能の実装

4. **エラーハンドリング**
   - APIのレスポンスに応じた適切なエラーメッセージの表示
   - ユーザーフレンドリーなエラー表示の実装
   - CORSエラーの解決と適切なヘッダー設定
   - エラー発生時の即時停止とリカバリー機能

5. **ダークモードの実装**
   - システムの設定に応じた自動切り替え
   - ユーザー設定の永続化（localStorage）
   - ページ遷移時の状態維持
   - コンポーネント間での状態共有（Context API）
   - スムーズな切り替えアニメーション

6. **位置情報の取得と表示**
   - ブラウザの位置情報APIの非同期処理
   - 位置情報の取得失敗時のフォールバック
   - 住所の逆ジオコーディング（緯度経度から住所への変換）

7. **リアルタイム通知**
   - 交通情報の定期的なポーリング
   - 通知の表示タイミングの最適化
   - 代替ルートの提案ロジック
   - エラー発生時の即時停止と再開機能

## 技術スタック

- **フロントエンド**: Next.js 14, TypeScript, Tailwind CSS
- **状態管理**: Redux Toolkit
- **地図API**: Google Maps Platform
- **認証**: カスタム認証システム
- **デプロイ**: Vercel

## 実装の課題と解決策

### 1. リアルタイム位置情報の取得と更新
- **課題**: 位置情報の頻繁な更新によるパフォーマンスの低下
- **解決策**: 
  - `useGeolocation`カスタムフックの実装
  - 位置情報の更新頻度の最適化
  - 不要な再レンダリングの防止

### 2. ルート変更の検出
- **課題**: 交通状況の変化をリアルタイムで検出
- **解決策**: 
  - `useRouteChangeDetection`カスタムフックの実装
  - 定期的なルート情報の更新
  - 変更検出時のユーザー通知

### 3. パフォーマンスの最適化
- **課題**: 地図の描画と位置情報の更新による負荷
- **解決策**: 
  - コンポーネントのメモ化
  - 不要な再レンダリングの防止
  - 効率的な状態管理

### 4. ユーザー認証の実装
- **課題**: セキュアな認証システムの構築
- **解決策**:
  - Reduxを使用した認証状態の管理
  - Cookieベースのセッション管理
  - ミドルウェアによる認証状態の検証
  - 未認証ユーザーの自動リダイレクト

### 5. 検索制限の実装
- **課題**: API使用量の制限とコスト管理
- **解決策**:
  - 1日3回までの目的地選択制限
  - 日付変更時の自動リセット機能
  - 残り検索回数の表示
  - 制限到達時のユーザー通知

## 認証機能の詳細

### ログイン処理
- メールアドレスとパスワードによる認証
- 認証成功時にユーザー情報をReduxストアに保存
- セッション管理用のCookieを設定
- ログイン後は自動的にホームページにリダイレクト

### ログアウト処理
- ナビゲーションバーのログアウトボタンから実行可能
- Reduxストアからユーザー情報を削除
- セッションCookieを削除
- ログアウト後は自動的にログインページにリダイレクト

### 認証状態の管理
- ミドルウェアによる認証状態の検証
- 未認証ユーザーは自動的にログインページにリダイレクト
- 認証済みユーザーがログインページにアクセスした場合はホームページにリダイレクト

## 検索制限の詳細

### 制限内容
- 1日3回までの目的地選択制限
- 日付変更時に自動的にリセット
- 残り検索回数の表示
- 制限到達時の通知

### 制限の仕組み
- Reduxストアで検索回数を管理
- Cookieで最終検索日を記録
- 日付変更時に自動リセット
- 検索時に残り回数を表示

### ユーザー体験
- 検索時に残り回数を通知
- 制限到達時に明確なメッセージを表示
- 翌日まで待機するよう案内

## 今後の改善点

1. **パフォーマンスの最適化**
   - コンポーネントのレンダリング最適化
   - データフェッチングの効率化

2. **ユーザー体験の向上**
   - ローディング状態の改善
   - エラーハンドリングの強化
   - アニメーションの追加

3. **機能の拡張**
   - 複数の目的地の設定
   - ルートの保存機能
   - カスタムマーカーの追加

4. **セキュリティの強化**
   - パスワードリセット機能の追加
   - 二要素認証の実装
   - セッション管理の改善

## 開発環境のセットアップ

1. リポジトリのクローン
```bash
git clone https://github.com/marumo333/fast-map.git
cd fast-map
```

2. 依存関係のインストール
```bash
npm install
```

3. 環境変数の設定
`.env.local`ファイルを作成し、必要な環境変数を設定：
```
NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=your_api_key
```

4. 開発サーバーの起動
```bash
npm run dev
```

## デプロイ

このアプリケーションはVercelにデプロイされています。mainブランチへのプッシュが自動的にデプロイをトリガーします。

## 環境変数

以下の環境変数を設定する必要があります：

```env
NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=your_api_key
```

## ライセンス

MIT

---

詳細な要件・仕様は [PRD.md](./PRD.md) を参照してください。
